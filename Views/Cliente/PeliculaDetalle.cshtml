@using PROYECTOMOVIE.Models
@model Pelicula
@{
    ViewData["Title"] = Model.Nombre_Peli; // Título de la pestaña del navegador
}

<head>
    <link rel="stylesheet" href="~/css/peliDetalles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
</head>

<body>

    <header class="header">
        <div class="logo"><i class="fa-solid fa-film"></i>WatchLenn</div>
        <nav class="nav-links">
            <a href="/Cliente/Index">Inicio</a>
            <a href="/Cliente/Pelis">Películas</a>
            <a href="/Cliente/Series">Series</a>
            <a href="#">Popular</a>
            <a href="/Cliente/ListasCliente">Mis Listas</a>
        </nav>

        <div class="nav-actions">
            <a href="/Cliente/Gemini" class="btn-login">Crea tu historia</a>

            <div class="user-info">
                <partial name="_LoginPartial" />
            </div>

            <div class="avatar"><i class="fa-solid fa-user"></i></div>
        </div>
    </header>

    <main>
        <div class="details-hero">

            <video class="trailer-video-bg" autoplay loop muted playsinline>
                <source src="@Model.Video_Trailer" type="video/mp4">
                Tu navegador no soporta videos HTML5.
            </video>
            <div class="video-overlay"></div>

            <button id="mute-toggle-btn" class="video-mute-btn">
                <i class="fa-solid fa-volume-xmark"></i>
            </button>
            <div class="details-content">
                
                <div class="details-poster">
                    <img src="@Model.Imagen_Peli" alt="@Model.Nombre_Peli">
                </div>

                <div class="details-info">
                    <h1 class="details-title">@Model.Nombre_Peli</h1>
                    
                    <div class="details-meta">
                        AÑO: @Model.Fecha_Publicada | DURACIÓN: @Model.Tiempo_Duracion | GÉNERO: 
                    </div>
                    
                    <p class="details-description">
                        @Model.Descripción
                    </p>

                    <div class="details-actions">
                        
                        <button class="btn-icon-action" aria-label="Añadir a favoritos">
                            <i class="fa-regular fa-heart"></i>
                        </button>
                        
                        <button class="btn-icon-action" aria-label="Añadir a mi lista" onclick="mostrarListas(@Model.Id)">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="movie-player-container" style="padding: 3rem 4%; background: #0a0a0a; text-align: center;"> 
            
            <h2 style="color: white; margin-bottom: 2rem; font-size: 2.2rem; font-weight: bold;">
                Ver ahora: @Model.Nombre_Peli
            </h2>
            
            <video id="movie-player" controls preload="metadata" style="width: 100%; max-width: 1200px; margin: 0 auto; display: block; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                
                <source src="@Model.Enlace_Peli" type="video/mp4">

                Tu navegador no soporta la reproducción de video.
            </video>
            
        </div>
        <div class="reviews-section">
            </div>
    </main>


    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const video = document.querySelector('.trailer-video-bg');
            const muteBtn = document.getElementById('mute-toggle-btn');

            if (video && muteBtn) {
                const icon = muteBtn.querySelector('i');
                
                muteBtn.addEventListener('click', function() {
                    video.muted = !video.muted; // Invierte el estado de silencio
                    
                    if (video.muted) {
                        icon.classList.remove('fa-volume-high');
                        icon.classList.add('fa-volume-xmark');
                    } else {
                        icon.classList.remove('fa-volume-xmark');
                        icon.classList.add('fa-volume-high');
                    }
                });
            }
        });
    </script>

    <!-- Modal para seleccionar lista -->
    <div class="modal fade" id="modalListas" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: rgba(20,22,24,0.98); border: 1px solid rgba(111, 66, 193, 0.3); border-radius: 16px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #6f42c1, #59309e); border-top-left-radius: 16px; border-top-right-radius: 16px; border-bottom: none;">
                    <h5 class="modal-title fw-bold" style="color: white;">
                        <i class="fa-solid fa-list me-2"></i> Agregar a lista
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" style="background: rgba(20,22,24,0.98); color: #fff;">
                    <div id="listasContainer" class="mb-3">
                        <!-- Las listas se cargarán aquí -->
                    </div>
                    <hr style="border-color: rgba(111, 66, 193, 0.2);" />
                    <div class="text-center">
                        <p class="text-muted small mb-3">¿No tienes listas?</p>
                        <a href="/Lista/Crear" class="btn w-100" style="background: linear-gradient(135deg, #6f42c1, #59309e); color: white; border-radius: 25px; padding: 10px;">
                            <i class="fa-solid fa-plus-circle me-2"></i> Crear nueva lista
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Token antifalsificación -->
    <input type="hidden" name="__RequestVerificationToken" value="@Html.AntiForgeryToken()" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let peliculaIdSeleccionada = 0;

        // Función para mostrar el modal con las listas
        function mostrarListas(peliculaId) {
            peliculaIdSeleccionada = peliculaId;
        
            // Mostrar loading
            $('#listasContainer').html(`
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            `);
        
            // Abrir modal
            $('#modalListas').modal('show');
        
            // Obtener listas del usuario
            $.get('/Lista/ObtenerListasUsuario', function(listas) {
                let html = '';
            
                if (listas.length === 0) {
                    html = `
                        <div class="alert alert-info text-center" style="background: rgba(111, 66, 193, 0.15); border: 1px solid rgba(111, 66, 193, 0.3); color: #fff;">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            No tienes listas creadas aún
                        </div>
                    `;
                } else {
                    html = '<div class="d-grid gap-2">';
                    listas.forEach(lista => {
                        html += `
                            <button class="btn text-start" 
                                    onclick="agregarALista(${lista.id}, ${peliculaId})"
                                    style="background: rgba(111, 66, 193, 0.1); 
                                        border: 1px solid rgba(111, 66, 193, 0.3); 
                                        color: #fff; 
                                        border-radius: 12px; 
                                        padding: 12px 16px;
                                        transition: all 0.3s;"
                                    onmouseover="this.style.background='rgba(111, 66, 193, 0.3)'"
                                    onmouseout="this.style.background='rgba(111, 66, 193, 0.1)'">
                                <i class="fa-solid fa-list me-2"></i> ${lista.nombre}
                            </button>
                        `;
                });
                html += '</div>';
            }
            
            $('#listasContainer').html(html);
        }).fail(function() {
            $('#listasContainer').html(`
                <div class="alert alert-danger">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                    Error al cargar las listas
                </div>
            `);
        });
    }

        // Función para agregar película a lista
        function agregarALista(listaId, peliculaId) {
            $.ajax({
                url: '/Lista/AgregarPelicula',
                type: 'POST',
                data: {
                    listaId: listaId,
                    peliculaId: peliculaId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(result) {
                    $('#modalListas').modal('hide');
                
                    if (result.success) {
                        alert('✓ ' + result.message);
                    } else {
                        alert('⚠ ' + result.message);
                    }
                },
                error: function() {
                    $('#modalListas').modal('hide');
                    alert('✗ No se pudo agregar la película. Intenta nuevamente.');
                }
            });
        }
    </script>

</body>